#include <Windows.h>
#include <mmdeviceapi.h>
#include <endpointvolume.h>
#include <QDebug>

bool toggleMicrophoneMute()
{
    CoInitialize(nullptr);

    IMMDeviceEnumerator* enumerator = nullptr;
    IMMDevice* device = nullptr;
    IAudioEndpointVolume* volume = nullptr;
    BOOL isMuted = FALSE;
    bool success = false;

    if (SUCCEEDED(CoCreateInstance(__uuidof(MMDeviceEnumerator), nullptr, CLSCTX_INPROC_SERVER,
                                   __uuidof(IMMDeviceEnumerator), (void**)&enumerator))) {
        if (SUCCEEDED(enumerator->GetDefaultAudioEndpoint(eCapture, eConsole, &device))) {
            if (SUCCEEDED(device->Activate(__uuidof(IAudioEndpointVolume), CLSCTX_ALL, nullptr, (void**)&volume))) {
                if (SUCCEEDED(volume->GetMute(&isMuted))) {
                    BOOL newMute = !isMuted;
                    if (SUCCEEDED(volume->SetMute(newMute, nullptr))) {
                        qDebug() << (newMute ? "Микрофон выключен" : "Микрофон включен");
                        success = true;
                    }
                }
                volume->Release();
            }
            device->Release();
        }
        enumerator->Release();
    }

    CoUninitialize();
    return success;
}